name: PR Audit Capture

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'dev-test/**'
      - 'prod-test/**'

  push:
    branches:
      - main
    paths:
      - 'dev-test/**'
      - 'prod-test/**'

jobs:
  capture-pr-details:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Audit Logic Only On Push
        run: |
          echo "Event Name: ${{ github.event_name }}"

          # ðŸš€ Only execute below block for PUSH to main
          if [ "${{ github.event_name }}" = "push" ]; then

            echo "Running audit logic for PUSH to main"

            # Get changed files for push
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt

            USER=${{ github.actor }}
            EVENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            echo "Triggered By: $USER"
            echo "Time: $EVENT_TIME"

            echo "Changed files:"
            cat changed_files.txt

            echo "----- Processing Changed Files -----"

            while read FILE; do

              # Detect Environment
              if [[ "$FILE" == dev-test/* ]]; then
                ENVIRONMENT="dev"
              elif [[ "$FILE" == prod-test/* ]]; then
                ENVIRONMENT="prod"
              else
                ENVIRONMENT="unknown"
              fi

              # Process only description.md inside CCR folders
              if [[ "$FILE" == dev-test/*/description.md || "$FILE" == prod-test/*/description.md ]]; then

                echo ""
                echo "Environment: $ENVIRONMENT"
                echo "Changed File: $FILE"

                if [ -f "$FILE" ]; then
                  echo "Description Content:"
                  echo "----------------------"
                  cat "$FILE"
                  echo "----------------------"
                else
                  echo "File was deleted"
                fi

              fi

            done < changed_files.txt
          fi

name: PR Audit Capture

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'dev-test/**'
      - 'prod-test/**'

  push:
    branches:
      - main
    paths:
      - 'dev-test/**'
      - 'prod-test/**'

jobs:
  capture-pr-details:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/GitHubOIDCRole
          aws-region: us-east-1

      - name: Run Audit Logic Only On Push
        run: |
          echo "Event Name: ${{ github.event_name }}"

          # ðŸš€ Only execute below block for PUSH to main
          if [ "${{ github.event_name }}" = "push" ]; then

            echo "Running audit logic for PUSH to main"

            BUCKET="my-audit-bucket"
            USER=${{ github.actor }}
            EVENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt

            echo "Triggered By: $USER"
            echo "Time: $EVENT_TIME"
            echo "Changed files:"
            cat changed_files.txt
            echo "----- Processing Changed Files -----"

            while read FILE; do

              # Detect Environment
              if [[ "$FILE" == dev-test/* ]]; then
                ENVIRONMENT="dev"
              elif [[ "$FILE" == prod-test/* ]]; then
                ENVIRONMENT="prod"
              else
                continue
              fi

              # Process only description.md
              if [[ "$FILE" == dev-test/*/description.md || "$FILE" == prod-test/*/description.md ]]; then

                echo ""
                echo "Environment: $ENVIRONMENT"
                echo "Changed File: $FILE"

                if [ -f "$FILE" ]; then

                  # Extract Policy Name
                  POLICY_NAME=$(grep "Policy Name:" "$FILE" | cut -d':' -f2 | xargs)

                  if [ -z "$POLICY_NAME" ]; then
                    echo "Policy Name not found in $FILE"
                    exit 1
                  fi

                  echo "Policy Name: $POLICY_NAME"

                  S3_KEY="audit/$ENVIRONMENT/${POLICY_NAME}.json"

                  # Try to download existing file
                  aws s3 cp s3://$BUCKET/$S3_KEY existing.json 2>/dev/null

                  if [ -f existing.json ]; then
                    echo "Policy exists â†’ Updating"

                    jq \
                      --arg date "$EVENT_TIME" \
                      --arg actor "$USER" \
                      '
                      .last_updated_at = $date |
                      .last_updated_by = $actor |
                      .history += [{"date": $date, "actor": $actor, "action": "updated"}]
                      ' existing.json > updated.json

                    aws s3 cp updated.json s3://$BUCKET/$S3_KEY

                    rm existing.json updated.json

                  else
                    echo "New policy â†’ Creating"

                    cat <<EOF > new.json
                    {
                      "policy_name": "$POLICY_NAME",
                      "environment": "$ENVIRONMENT",
                      "created_at": "$EVENT_TIME",
                      "created_by": "$USER",
                      "last_updated_at": "$EVENT_TIME",
                      "last_updated_by": "$USER",
                      "history": [
                        {
                           "date": "$EVENT_TIME",
                            "actor": "$USER",
                            "action": "created"
                        }
                      ]
                    }
                  EOF

                    aws s3 cp new.json s3://$BUCKET/$S3_KEY
                    rm new.json
                  fi

                else
                  echo "File was deleted"
                fi
              fi

            done < changed_files.txt

          else
            echo "Pull request event detected â€” No S3 audit execution."
          fi

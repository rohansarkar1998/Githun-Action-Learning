name: PR Audit Capture

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'dev-test/**'
      - 'prod-test/**'

  push:
    branches:
      - main
    paths:
      - 'dev-test/**'
      - 'prod-test/**'

jobs:
  capture-pr-details:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Run Audit Logic (Push Only)
        run: |
          echo "Event Name: ${{ github.event_name }}"

          if [ "${{ github.event_name }}" != "push" ]; then
            echo "Pull request event detected — No S3 audit execution."
            exit 0
          fi

          echo "Running audit logic for PUSH to main"

          BUCKET="my-audit-bucket"
          USER=${{ github.actor }}
          EVENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "Triggered By: $USER"
          echo "Time: $EVENT_TIME"

          # Get changed files
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt

          echo "Changed files:"
          cat changed_files.txt

          echo "----- Extracting Unique CCR Folders -----"

          # Extract unique dev-test/ccrX or prod-test/ccrX folders
          FOLDERS=$(awk -F/ '/^(dev-test|prod-test)\// {print $1"/"$2}' changed_files.txt | sort -u)

          for FOLDER in $FOLDERS; do

            echo ""
            echo "Processing Folder: $FOLDER"

            # Determine environment
            if [[ "$FOLDER" == dev-test/* ]]; then
              ENVIRONMENT="dev"
            elif [[ "$FOLDER" == prod-test/* ]]; then
              ENVIRONMENT="prod"
            else
              continue
            fi

            DESCRIPTION_FILE="$FOLDER/description.md"

            if [ ! -f "$DESCRIPTION_FILE" ]; then
              echo "description.md missing in $FOLDER"
              continue
            fi

            # Extract Policy Name from description.md
            POLICY_NAME=$(grep "Policy Name:" "$DESCRIPTION_FILE" | cut -d':' -f2 | xargs)

            if [ -z "$POLICY_NAME" ]; then
              echo "Policy Name not found in $DESCRIPTION_FILE"
              exit 1
            fi

            echo "Environment: $ENVIRONMENT"
            echo "Policy Name: $POLICY_NAME"

            CCR_NAME=$(basename $FOLDER)
            S3_KEY="audit/$ENVIRONMENT/${CCR_NAME}.json"

            # Try downloading existing policy record
            aws s3 cp s3://$BUCKET/$S3_KEY existing.json 2>/dev/null

            if [ -f existing.json ]; then

              echo "Policy exists → Updating"

              jq \
                --arg date "$EVENT_TIME" \
                --arg actor "$USER" \
                --arg pname "$POLICY_NAME" \
                '
                .policy_name = $pname |
                .last_updated_at = $date |
                .last_updated_by = $actor |
                .history += [{"date": $date, "actor": $actor, "action": "updated"}]
                ' existing.json > updated.json

              aws s3 cp updated.json s3://$BUCKET/$S3_KEY

              rm existing.json updated.json

            else

              echo "New policy → Creating"

              cat <<EOF > new.json
              {
                "policy_id": "$CCR_NAME",
                "policy_name": "$POLICY_NAME",
                "environment": "$ENVIRONMENT",
                "created_at": "$EVENT_TIME",
                "created_by": "$USER",
                "last_updated_at": "$EVENT_TIME",
                "last_updated_by": "$USER",
                "history": [
                 {
                   "date": "$EVENT_TIME",
                   "actor": "$USER",
                   "action": "created"
                 }
                ]
              }
              EOF

             aws s3 cp new.json s3://$BUCKET/$S3_KEY

              rm new.json
            fi

          done
